---
title: "R Notebook"
output: html_notebook
---
## Packages
```{r Packages}
# Execute apenas se já tiver os pacotes
# install.packages("plotly")
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("orca") # Aparentemente foi descontinuado
```
## Library
```{r library}
library(dplyr)
# library(plotly)
# library(orca)
#library("magrittr")
```
## Leitura do CSV: Leitura das tabelas de HABILIDADE do item das áreas
```{r}
habil_modelo_2PLM_LTM_LC_PA <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_LC_PA.csv", header = TRUE, sep= ",")
habil_modelo_2PLM_LTM_CN_PA <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_CN_PA.csv", header = TRUE, sep= ",")
habil_modelo_2PLM_LTM_CH_PA <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_CH_PA.csv", header = TRUE, sep= ",")
habil_modelo_2PLM_LTM_MT_PA <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_MT_PA.csv", header = TRUE, sep= ",")

habil_modelo_2PLM_LTM_LC_PR <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_LC_PR.csv", header = TRUE, sep= ",")
habil_modelo_2PLM_LTM_CN_PR <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_CN_PR.csv", header = TRUE, sep= ",")
habil_modelo_2PLM_LTM_CH_PR <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_CH_PR.csv", header = TRUE, sep= ",")
habil_modelo_2PLM_LTM_MT_PR <- read.table("codigos_R/LTM_2PL/habilidades/habil_modelo_2PLM_LTM_MT_PR.csv", header = TRUE, sep= ",")
```

## Leitura do CSV: Leitura das tabelas de dificuldade do item das áreas
```{r}
dif_2PLM_LTM_LC_PR <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_LC_PR.csv", header = TRUE, sep= ",")
dif_2PLM_LTM_MT_PR <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_MT_PR.csv", header = TRUE, sep= ",")
dif_2PLM_LTM_CN_PR <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_CN_PR.csv", header = TRUE, sep= ",")
dif_2PLM_LTM_CH_PR <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_CH_PR.csv", header = TRUE, sep= ",")

dif_2PLM_LTM_LC_PA <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_LC_PA.csv", header = TRUE, sep= ",")
dif_2PLM_LTM_MT_PA <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_MT_PA.csv", header = TRUE, sep= ",")
dif_2PLM_LTM_CN_PA <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_CN_PA.csv", header = TRUE, sep= ",")
dif_2PLM_LTM_CH_PA <- read.table("codigos_R/LTM_2PL/dificuldades/dif_2PLM_LTM_CH_PA.csv", header = TRUE, sep= ",")
```

```{r}
min(habil_modelo_2PLM_LTM_CH_PA$habilidade)
max(habil_modelo_2PLM_LTM_CH_PA$habilidade)

min(habil_modelo_2PLM_LTM_LC_PA$habilidade)
max(habil_modelo_2PLM_LTM_LC_PA$habilidade)

min(habil_modelo_2PLM_LTM_CN_PA$habilidade)
max(habil_modelo_2PLM_LTM_CN_PA$habilidade)

min(habil_modelo_2PLM_LTM_MT_PA$habilidade)
max(habil_modelo_2PLM_LTM_MT_PA$habilidade)

min(habil_modelo_2PLM_LTM_CH_PR$habilidade)
max(habil_modelo_2PLM_LTM_CH_PR$habilidade)

min(habil_modelo_2PLM_LTM_LC_PR$habilidade)
min(habil_modelo_2PLM_LTM_CN_PR$habilidade)
min(habil_modelo_2PLM_LTM_MT_PR$habilidade)
```

```{r}
#theta <- seq(-4,4,.1)
```

#valores 
a = discriminação
b = dificuldade
theta = coluna de habilidade
c = probabilidade de chute
```{r}
 gera_probabilidade <- function(theta,a,b,c){
    # theta <- seq(-3,3,.1)
    # P <- c + (1 - c) + pnorm(a * (theta - b))
    L <- a * (theta - b)
    expnl <- exp(-L)
    opexpnl <- 1 + expnl
    P <- 1 / opexpnl
              
    return(P)
  }
```
# Função que cria uma lista de vetores de probabilidades #ALTERAR
Função retorna uma lista: onde cada indice da lista[[i]] tem um vetor de
probabilidades de acordo com a dificuldade do cada item data_dificuldade
= dataframe de dificuldade do item total_questao = total questao das
provas

```{r criar lista de probabilidades de acordo com a dificuldade do item}
criar_lista <- function(theta,df_dificuldade,c){
  qtd_itens <- nrow(df_dificuldade)
  lista <- list()
  
  for(i in 1:qtd_itens){
    lista[[i]] <- gera_probabilidade(theta,df_dificuldade$discriminacao_item[i], df_dificuldade$dificuldade_item[i], c)
  }

  return(lista)
}
```

# Tratamento do Dataframe
Step 1: as.data.frame(do.call(rbind, lista_prob)): combina os elementos
de uma lista de dataframes usando a função rbind() e retorna um único
dataframe com todas probabilidades estimadas. Step 2: o df 
as.data.frame(t(df)) é usada para transpor um dataframe e transformar as
colunas em linhas. Step 3: Cria uma coluna com os valores do vetor theta

```{r}
tratamento_df <- function(lista_prob,theta,df_dificuldade){
  total_itens <- nrow(df_dificuldade)
  df <- as.data.frame(do.call(rbind,lista_prob)) #step1
  df <- as.data.frame(t(df)) #step2
  df["theta"] <- theta #step3
  lista_aux <- list()
 
  for(i in 1:total_itens){
    lista_aux <- append(lista_aux, paste("Item ",df_dificuldade["questao"][i,1]))
  }
  colnames(df) <- c(lista_aux,"theta")
  df <- df %>% relocate(theta, .before = colnames(df)[1])
  row.names(df) <- NULL
  return(df)
}
```

## Gerar gráfico de Probabilidade de acerto do item

```{r Funcão para gerar scatter}
# gera_Scatter <- function(df, vetor_num_item){
#   total_itens <- ncol(df)
#   Scatter <- plot_ly(x = df$theta, #pegar a coluna theta
#                      y =df[vetor_num_item[2]][,], #Iniciar pela 2º coluna devido a 1º conter os valores de Theta
#                      name = vetor_num_item[1], #Iniciar pelo primeiro valor ITEM 1
#                      type = "scatter",
#                      mode = "lines"
#                      ) %>%
#           layout(xaxis = list(title = 'theta θ',
#                         zeroline = F
#                        ),
#            yaxis = list(title = 'P (θ)',
#                         zeroline = F
#                         ))
  
  
#   for(i in 3:total_itens){ #continuar o loop
#     Scatter <-Scatter %>% add_trace(x = df$theta, 
#                                     y = df[,i],
#                                     name = vetor_num_item[i-1]) #ele vai até -1 devido a coluna do theta no dataframe
#   }
#   return(Scatter)
# }
```


```{r Funcão para gerar scatter facil medio e dificil}
# gera_Scatter_comp_oficial <- function(df, vetor_itens){
#   Scatter <- plot_ly(x = df$theta, #pegar a coluna theta
#                      y =df[,vetor_itens[1]+1], #Iniciar pela 2º coluna devido a 1º conter os valores de Theta
#                      name = names(df)[vetor_itens[1]+1], #Iniciar pelo primeiro valor ITEM 1
#                      type = "scatter",
#                      mode = "lines"
#                      ) %>%
#           layout(xaxis = list(title = 'Habilidade θ',
#                         zeroline = F
#                        ),
#            yaxis = list(title = 'Probabilidade de acerto P(θ)',
#                         zeroline = F
#                         ))
#   for(i in 2:length(vetor_itens)){
#      Scatter <-Scatter %>% add_trace(x = df$theta, 
#                                     y = df[,vetor_itens[i]+1],
#                                     name =  names(df)[vetor_itens[i]+1]) #ele vai até -1 devido a coluna do theta no
#   }
#   return(Scatter)
# }
```


#Gera todos dataframe de todas as ares e suas probabilidades

```{r}
theta <- seq(-5,5,.0001)
df_prob_2PL_LTM_LC_PA <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_LC_PA,0), theta, dif_2PLM_LTM_LC_PA)
df_prob_2PL_LTM_MT_PA <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_MT_PA,0), theta, dif_2PLM_LTM_MT_PA)
df_prob_2PL_LTM_CN_PA <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_CN_PA,0), theta, dif_2PLM_LTM_CN_PA)
df_prob_2PL_LTM_CH_PA <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_CH_PA,0), theta, dif_2PLM_LTM_CH_PA)

#Paraná
df_prob_2PL_LTM_LC_PR <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_LC_PR,0), theta, dif_2PLM_LTM_LC_PR)
df_prob_2PL_LTM_MT_PR <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_MT_PR,0), theta, dif_2PLM_LTM_MT_PR)
df_prob_2PL_LTM_CN_PR <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_CN_PR,0), theta, dif_2PLM_LTM_CN_PR)
df_prob_2PL_LTM_CH_PR <- tratamento_df(criar_lista(theta, dif_2PLM_LTM_CH_PR,0), theta, dif_2PLM_LTM_CH_PR)
```

```{r}
dif_2PLM_LTM_LC_PR 
dif_2PLM_LTM_MT_PR
dif_2PLM_LTM_CN_PR
dif_2PLM_LTM_CH_PR

dif_2PLM_LTM_LC_PA
dif_2PLM_LTM_MT_PA
dif_2PLM_LTM_CN_PA
dif_2PLM_LTM_CH_PA
```
```{r}
dif_2PLM_LTM_LC_PR$discriminacao_item[38]
```

```{r}
# Já estão salvos. Demora um pouco para refazer a operação
# write.csv(df_prob_2PL_LTM_LC_PA, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_LC_PA.csv", row.names=FALSE)
# write.csv(df_prob_2PL_LTM_MT_PA, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_MT_PA.csv", row.names=FALSE)
# write.csv(df_prob_2PL_LTM_CN_PA, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_CN_PA.csv", row.names=FALSE)
# write.csv(df_prob_2PL_LTM_CH_PA, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_CH_PA.csv", row.names=FALSE)

# #Paraná
# write.csv(df_prob_2PL_LTM_LC_PR, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_LC_PR.csv", row.names=FALSE)
# write.csv(df_prob_2PL_LTM_MT_PR, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_MT_PR.csv", row.names=FALSE)
# write.csv(df_prob_2PL_LTM_CN_PR, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_CN_PR.csv", row.names=FALSE)
# write.csv(df_prob_2PL_LTM_CH_PR, "codigos_R/LTM_2PL/probabilidades/df_prob_2PL_LTM_CH_PR.csv", row.names=FALSE)
```


#Ordenar dataframes
```{r}
ordenar_questoes <- function(df) {
  # Ordenar dataframe pelo valor da coluna dificuldade
  
  # Selecionar as 3 questoes mais faceis, mais dificies e as que estão na média
  vetor_facil <- df[order(df$dificuldade_item),][1:3,]$questao
  vetor_dificil <- df[order(df$dificuldade_item, decreasing = TRUE),][1:3,]$questao
  
  # Encontrar a média 
  mediana <- median(df$dificuldade_item)
  vetor_medias <- df[order(abs(df$dificuldade_item - mediana)),][1:3,]$questao
  # Retornar um vetor com as 3 listas de itens selecionadas
  return(c(vetor_facil,vetor_medias,vetor_dificil))
}
```

```{r}
# gera_Scatter_comp <- function(df, vetor_itens, valor1, valor2,examinando_A="",examinando_B="",titulo = "") {
#   Scatter <- plot_ly(x = df$theta,
#                      y = df[, vetor_itens[1] + 1],
#                      name = names(df)[vetor_itens[1] + 1],
#                      type = "scatter",
#                      mode = "lines"
#   ) %>% 
    
#     layout(title = titulo,
#       xaxis = list(title = 'Habilidade θ',
#                         zeroline = FALSE
#     ),
#     yaxis = list(title = 'Probabilidade P(θ)',
#                  zeroline = FALSE
#     ))

#   for(i in 2:length(vetor_itens)) {
#     Scatter <- Scatter %>% add_trace(x = df$theta,
#                                      y = df[, vetor_itens[i] + 1],
#                                      name = names(df)[vetor_itens[i] + 1]
#     )
#   }
#   Scatter <- Scatter %>% add_annotations(
#     x = valor1$theta,
#     y = valor1$probabilidade,
#     text = paste(examinando_A,"<br>Habilidade θ:", round(valor1$theta, 2),
#                 "<br>Discriminação do item:",round(valor1$discriminacao,2),
#                  "<br>Probabilidade P(θ):", round(valor1$probabilidade, 2)*100,"%"),
#     xref = "x",
#     yref = "y",
#     showarrow = TRUE,
#     arrowhead = 7,
#     arrowwidth = 2,
#     ax = valor1$theta -100,
#     ay = -50,
#     arrowcolor="#636363",
#     bordercolor="#c7c7c7",
#     bgcolor="#63A0CB",
#     font = list(color = "White",weight = "bold")
#   )
#     # Adicionar anotações para os valores destacados
#   Scatter <- Scatter %>% add_annotations(
#     x = valor2$theta,
#     y = valor2$probabilidade,
#     text = paste(examinando_B,"<br>Habilidade θ:", round(valor2$theta, 2),
#                  "<br>Discriminação do item:",round(valor2$discriminacao,2),
#                  "<br>Probabilidade P(θ):", round(valor2$probabilidade, 2)*100,"%"),
#     xref = "x",
#     yref = "y",
#     showarrow = TRUE,
#     arrowhead = 7,
#     arrowwidth = 2,
#     ax = valor2$theta -40,
#     ay = -100,
#     arrowcolor="#636363",
#     bordercolor="#c7c7c7",
#     bgcolor="#8C564B",
#     font = list(color = "White",weight = "bold")
#   )
 
#   return(Scatter)
# }

```


```{r}

# item_32_PR <- data.frame(theta = -1.85, probabilidade = 0.50,discriminacao = dif_2PLM_LTM_LC_PR$discriminacao_item[32])
# item_31_PR <- data.frame(theta = 2.7, probabilidade = 0.50,discriminacao = dif_2PLM_LTM_LC_PR$discriminacao_item[31])

# item_32_PA <- data.frame(theta = -1.09, probabilidade = 0.50,discriminacao= dif_2PLM_LTM_LC_PA$discriminacao_item[32])
# item_31_PA <- data.frame(theta = 4.0, probabilidade = 0.27, discriminacao =dif_2PLM_LTM_LC_PA$discriminacao_item[31])

# scatter_plot_LC_PR <- gera_Scatter_comp(df_prob_2PL_LTM_LC_PR,c(31,26,24,33,17,32,18),item_31_PR,item_32_PR,"item 31","item 32", "CCI de Linguagens e Códigos do estado do Paraná")
# scatter_plot_LC_PA <- gera_Scatter_comp(df_prob_2PL_LTM_LC_PA,c(31,26,24,33,17,32,18),item_31_PA,item_32_PA,"item 31","item 32", "CCI de Linguagens e Códigos do estado do Pará")

```

```{r}
# scatter_plot_LC_PR
# scatter_plot_LC_PA

#scatter_plot_MT_PR
#scatter_plot_MT_PA
```

```{r}
#orca(scatter_plot_MT_PR,"graficos/grafico_2PL_LTM_MT_PR.pdf")
#orca(scatter_plot_CN_PR,"graficos/grafico_2PL_LTM_CN_PR.pdf")
#orca(scatter_plot_CH_PR,"graficos/grafico_2PL_LTM_CH_PR.pdf")

#orca(scatter_plot_MT_PA,"graficos/grafico_2PL_LTM_MT_PA.pdf")
# orca(scatter_plot_LC_PA,"graficos/grafico_2PL_LTM_LC_PA.pdf")
# orca(scatter_plot_LC_PR,"graficos/grafico_2PL_LTM_LC_PR.pdf")
#orca(scatter_plot_CN_PA,"graficos/grafico_2PL_LTM_CN_PA.pdf")
#orca(scatter_plot_CH_PA,"graficos/grafico_2PL_LTM_CH_PA.pdf")
```

```{r}
theta <- seq(-5,5,.0001)
plot(theta, gera_probabilidade(theta,dif_2PLM_LTM_MT_PR$discriminacao_item[1], dif_2PLM_LTM_MT_PR$dificuldade_item[1],0))

plot(theta, gera_probabilidade(theta,dif_2PLM_LTM_MT_PR$discriminacao_item[41], dif_2PLM_LTM_MT_PR$dificuldade_item[41],0))
```
