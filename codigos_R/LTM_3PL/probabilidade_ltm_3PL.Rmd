---
title: "R Notebook"
output: html_notebook
---

## Packages
```{r Packages}
# install.packages("plotly")
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("orca")
```

## Library
```{r library}
library(dplyr)
# library(plotly)
# library(orca)
#library("magrittr")
```

## Leitura do CSV: Leitura das tabelas de HABILIDADE do item das áreas
```{r}
habil_3PL_ltm_LC_PA <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_LC_PA.csv", header = TRUE, sep= ",")
habil_3PL_ltm_CN_PA <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_CN_PA.csv", header = TRUE, sep= ",")
habil_3PL_ltm_CH_PA <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_CH_PA.csv", header = TRUE, sep= ",")
habil_3PL_ltm_MT_PA <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_MT_PA.csv", header = TRUE, sep= ",")

habil_3PL_ltm_LC_PR <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_LC_PR.csv", header = TRUE, sep= ",")
habil_3PL_ltm_CN_PR <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_CN_PR.csv", header = TRUE, sep= ",")
habil_3PL_ltm_CH_PR <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_CH_PR.csv", header = TRUE, sep= ",")
habil_3PL_ltm_MT_PR <- read.table("codigos_R/LTM_3PL/habilidades/habil_3PL_ltm_MT_PR.csv", header = TRUE, sep= ",")

```
## Leitura do CSV: Leitura das tabelas de DIFICULDADE do item das áreas
```{r}
dif_modelo_3PL_ltm_LC_PR <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_LC_PR.csv", header = TRUE, sep= ",")
dif_modelo_3PL_ltm_CN_PR <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_CN_PR.csv", header = TRUE, sep= ",")
dif_modelo_3PL_ltm_CH_PR <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_CH_PR.csv", header = TRUE, sep= ",")
dif_modelo_3PL_ltm_MT_PR <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_MT_PR.csv", header = TRUE, sep= ",")

dif_modelo_3PL_ltm_LC_PA <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_LC_PA.csv", header = TRUE, sep= ",")
dif_modelo_3PL_ltm_CN_PA <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_CN_PA.csv", header = TRUE, sep= ",")
dif_modelo_3PL_ltm_CH_PA <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_CH_PA.csv", header = TRUE, sep= ",")
dif_modelo_3PL_ltm_MT_PA <- read.table("codigos_R/LTM_3PL/dificuldades/dif_modelo_3PL_ltm_MT_PA.csv", header = TRUE, sep= ",")

```

#valores 
a = discriminação
b = dificuldade
theta = coluna de habilidade
c = probabilidade de chute
```{r}
 gera_probabilidade <- function(theta,b,a,c){
   # theta <- seq(-3,3,.1)
     P <- c + (1 - c) * pnorm(a * (theta - b))
    #P <- 1 / (1 + exp(-a * (theta - b)))
    return(P)
  }
```

# Função que cria uma lista de vetores de probabilidades #ALTERAR
Função retorna uma lista: onde cada indice da lista[[i]] tem um vetor de
probabilidades de acordo com a dificuldade do cada item data_dificuldade
= dataframe de dificuldade do item total_questao = total questao das
provas

```{r criar lista de probabilidades de acordo com a dificuldade do item}
criar_lista <- function(theta,df_dificuldade){
  qtd_itens <- nrow(df_dificuldade)
  lista <- list()
  
  for(i in 1:qtd_itens){
    lista[[i]] <- gera_probabilidade(theta,df_dificuldade$dificuldade_item[i],df_dificuldade$discriminacao_item[i],df_dificuldade$acerto_acaso_item[i])
  }

  return(lista)
}
```

# Tratamento do Dataframe
Step 1: as.data.frame(do.call(rbind, lista_prob)): combina os elementos
de uma lista de dataframes usando a função rbind() e retorna um único
dataframe com todas probabilidades estimadas. Step 2: o df 
as.data.frame(t(df)) é usada para transpor um dataframe e transformar as
colunas em linhas. Step 3: Cria uma coluna com os valores do vetor theta

```{r}
tratamento_df <- function(theta,lista_prob,df_dificuldade){
  total_itens <- nrow(df_dificuldade)
  df <- as.data.frame(do.call(rbind,lista_prob)) #step1
  df <- as.data.frame(t(df)) #step2
  df["theta"] <- theta #step3
  lista_aux <- list()
 
  for(i in 1:total_itens){
    lista_aux <- append(lista_aux, paste("Item ",df_dificuldade["questao"][i,1]))
  }
  colnames(df) <- c(lista_aux,"theta")
  df <- df %>% relocate(theta, .before = colnames(df)[1])
  row.names(df) <- NULL
  return(df)
}
```

#Gera todos dataframe de todas as ares e suas probabilidades

```{r}
theta <- seq(-5,5,.0001)
prob_3PL_ltm_LC_PA <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_LC_PA), dif_modelo_3PL_ltm_LC_PA)
prob_3PL_ltm_MT_PA <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_MT_PA), dif_modelo_3PL_ltm_MT_PA)
prob_3PL_ltm_CN_PA <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_CN_PA), dif_modelo_3PL_ltm_CN_PA)
prob_3PL_ltm_CH_PA <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_CH_PA), dif_modelo_3PL_ltm_CH_PA)

prob_3PL_ltm_LC_PR <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_LC_PR), dif_modelo_3PL_ltm_LC_PR)
prob_3PL_ltm_MT_PR <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_MT_PR), dif_modelo_3PL_ltm_MT_PR)
prob_3PL_ltm_CN_PR <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_CN_PR), dif_modelo_3PL_ltm_CN_PR)
prob_3PL_ltm_CH_PR <- tratamento_df(theta,criar_lista(theta, dif_modelo_3PL_ltm_CH_PR), dif_modelo_3PL_ltm_CH_PR)
```

```{r}
write.csv(prob_3PL_ltm_LC_PR, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_LC_PR.csv", row.names=FALSE)
write.csv(prob_3PL_ltm_MT_PR, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_MT_PR.csv", row.names=FALSE)
write.csv(prob_3PL_ltm_CH_PR, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_CH_PR.csv", row.names=FALSE)
write.csv(prob_3PL_ltm_CN_PR, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_CN_PR.csv", row.names=FALSE)

#ES
write.csv(prob_3PL_ltm_LC_PA, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_LC_PA.csv", row.names=FALSE)
write.csv(prob_3PL_ltm_MT_PA, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_MT_PA.csv", row.names=FALSE)
write.csv(prob_3PL_ltm_CH_PA, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_CH_PA.csv", row.names=FALSE)
write.csv(prob_3PL_ltm_CN_PA, "codigos_R/LTM_3PL/probabilidades/df_prob_3PL_LTM_CN_PA.csv", row.names=FALSE)
```

#Plot
#Ordenar dataframes
```{r}
ordenar_questoes <- function(df) {
  # Ordenar dataframe pelo valor da coluna dificuldade
  
  # Selecionar as 3 questoes mais faceis, mais dificies e as que estão na média
  vetor_facil <- df[order(df$dificuldade_item),][1:3,]$questao
  vetor_dificil <- df[order(df$dificuldade_item, decreasing = TRUE),][1:3,]$questao
  
  # Encontrar a média 
  mediana <- median(df$dificuldade_item)
  vetor_medias <- df[order(abs(df$dificuldade_item - mediana)),][1:3,]$questao
  # Retornar um vetor com as 3 listas de itens selecionadas
  print(c(vetor_facil,vetor_medias,vetor_dificil))
  return(c(vetor_facil,vetor_medias,vetor_dificil))
}
```

```{r}
# gera_Scatter_pers <- function(df, vetor_itens,titulo){
#   Scatter <- plot_ly(x = df$theta, #pegar a coluna theta
#                      y =df[,vetor_itens[1]], #Iniciar pela 2º coluna devido a 1º conter os valores de Theta
#                      name = names(df)[vetor_itens[1]], #Iniciar pelo primeiro valor ITEM 1
#                      type = "scatter",
#                      mode = "lines",
#                      #showlegend = FALSE
#                      ) %>%
#           layout(title = titulo, xaxis = list(title = 'Habilidade θ',
#                         zeroline = F
#                        ),
#            yaxis = list(title = 'Probabilidade de acerto P(θ)',
#                         zeroline = F
#                         ))

#   return(Scatter)
# }
```

```{r}
specific_row <- dif_modelo_3PL_ltm_CH_PA[38, ]  # Access the third row
specific_row[1]$acerto_acaso_item
```

```{r}
# gera_Scatter_p <- function(probabilidade,theta, vetor_itens,titulo){
#   Scatter <- plot_ly(x = theta, #pegar a coluna theta
#                      y = probabilidade, #Iniciar pela 2º coluna devido a 1º conter os valores de Theta
#                      name = names(df)[vetor_itens[1]], #Iniciar pelo primeiro valor ITEM 1
#                      type = "scatter",
#                      mode = "lines",
#                      #showlegend = FALSE
#                      ) %>%
#           layout(title = titulo, xaxis = list(title = 'Habilidade θ',
#                         zeroline = F
#                        ),
#            yaxis = list(title = 'Probabilidade de acerto P(θ)',
#                         zeroline = F
#                         ))

#   return(Scatter)
# }
```

```{r}
# theta <- seq(-5,5,.0001)
# specific_row <- dif_modelo_3PL_ltm_CH_PR[38, ]  # Access the third row
# b <- specific_row[2]$dificuldade_item
# a <- specific_row[3]$discriminacao_item #
# #a <- 8
# c <- specific_row[1]$acerto_acaso_item
# #c <- 0
# #C muito próximo de 0 não tem influência
# # Quando o C > 0 influencia no eixo Y (Probabilidade de acerto)

# probabilidade <- gera_probabilidade(theta,b,a,c)
# scatter_plot_CCI_PR <- gera_Scatter_p(probabilidade,theta,c(38),"Curva Característica do Item")
```

```{r}
# a
# b
# c
```

```{r}
# scatter_plot_CCI_PR
```


```{r}
# theta <- seq(-5,5,.0001)
# specific_row <- dif_modelo_3PL_ltm_CH_PA[38, ]  # Access the third row
# b <- specific_row[2]$dificuldade_item
# a <- specific_row[3]$discriminacao_item
# #a <- 1
# c <- specific_row[1]$acerto_acaso_item
# #c <- 0
# #C muito próximo de 0 não tem influência
# probabilidade <- gera_probabilidade(theta,b,a,c)
# scatter_plot_CCI_PA <- gera_Scatter_p(probabilidade,theta,c(38),"Curva Característica do Item")
```

```{r}
# a
# b
# c
```


```{r}
# scatter_plot_CH_PR
# scatter_plot_CH_PA
```

```{r}
# scatter_plot_CCI_PA

```

## Gerar gráfico de Probabilidade de acerto do item

```{r Funcão para gerar scatter}
# gera_Scatter <- function(df, vetor_num_item){
#   total_itens <- ncol(df)
#   Scatter <- plot_ly(x = df$theta, #pegar a coluna theta
#                      y =df[vetor_num_item[2]][,], #Iniciar pela 2º coluna devido a 1º conter os valores de Theta
#                      name = vetor_num_item[1], #Iniciar pelo primeiro valor ITEM 1
#                      type = "scatter",
#                      mode = "lines"
#                      ) %>%
#           layout(xaxis = list(title = 'theta θ',
#                         zeroline = F
#                        ),
#            yaxis = list(title = 'P (θ)',
#                         zeroline = F
#                         ))
  
  
#   for(i in 3:total_itens){ #continuar o loop
#     Scatter <-Scatter %>% add_trace(x = df$theta, 
#                                     y = df[,i],
#                                     name = vetor_num_item[i-1]) #ele vai até -1 devido a coluna do theta no dataframe
#   }
#   return(Scatter)
# }
```

#Esse Scatter gera a comparação de dois examinandos de habilidades distintas de em determinado item
```{r} 
# gera_Scatter_comp <- function(df, vetor_itens, valor1, valor2,examinando_A = "",examinando_B = "",titulo = "") {
#   Scatter <- plot_ly(x = df$theta,
#                      y = df[, vetor_itens[1] + 1],
#                      name = names(df)[vetor_itens[1] + 1],
#                      type = "scatter",
#                      mode = "lines"
#                      ) %>% 
#     layout(title = titulo,
#       xaxis = list(title = 'Habilidade θ',
#                         zeroline = FALSE
#     ),
#     yaxis = list(title = 'Probabilidade P(θ)',
#                  zeroline = FALSE
#     ))

#   for(i in 2:length(vetor_itens)) {
#     Scatter <- Scatter %>% add_trace(x = df$theta,
#                                      y = df[, vetor_itens[i] + 1],
#                                      name = names(df)[vetor_itens[i] + 1]
#     )
#     }

#   # Adicionar anotações para os valores destacados
#   Scatter <- Scatter %>% add_annotations(
#     x = valor1$theta,
#     y = valor1$probabilidade,
#     text = paste(examinando_A,"<br>Habilidade (θ):", round(valor1$theta, 2),
#                 "<br>Discriminação do item:",round(valor1$discriminacao,2),
#                 "<br>Acerto ao acaso:",round(valor1$acerto_acaso_item,4),
#                  "<br>Probabilidade P(θ):", round(valor1$probabilidade, 2)*100,"%"),
#     showarrow = TRUE,
#     arrowhead = 7,
#     arrowwidth = 2,
#     ax = valor1$theta - 100, #posicao do aluno
#     ay = -100, 
#     arrowcolor="#636363",
#     bordercolor="#c7c7c7",
#     bgcolor="#2CA02C",
#     font = list(color = "White", weight = "bold")
    
#   )

#   Scatter <- Scatter %>% add_annotations(
#     x = valor2$theta,
#     y = valor2$probabilidade,
#     text = paste(examinando_B,"<br>Habilidade θ:", round(valor2$theta, 2),
#                 "<br>Discriminação do item:",round(valor2$discriminacao,2),
#                  "<br>Acerto ao acaso:",round(valor2$acerto_acaso_item,4),
#                  "<br>Probabilidade P(θ):", round(valor2$probabilidade, 2)*100,"%"),
#     xref = "x",
#     yref = "y",
#     showarrow = TRUE,
#     arrowhead = 7,
#     arrowwidth = 2,
#     ax = valor2$theta,
#     ay = 140,
#     arrowcolor="#636363",
#     bordercolor="#c7c7c7",
#     bgcolor="#1F77B4",
#     font = list(color = "White",weight = "bold")
#   )
 
#   return(Scatter)
# }

```


```{r}
#df, vetor_itens, valor1, valor2

# item_36_PR <- data.frame(theta = -1.8, 
#                          probabilidade = 0.50,
#                          discriminacao = dif_modelo_3PL_ltm_CH_PR$discriminacao_item[36], 
#                          acerto_acaso_item = dif_modelo_3PL_ltm_CH_PR$acerto_acaso_item[36]
#                          )
# item_38_PR <- data.frame(theta = 2.0, 
#                          probabilidade = 0.50,
#                          discriminacao = dif_modelo_3PL_ltm_CH_PR$discriminacao_item[38],
#                          acerto_acaso_item =dif_modelo_3PL_ltm_CH_PR$acerto_acaso_item[38]
#                          )

# scatter_plot_CH_PR <- gera_Scatter_comp(prob_3PL_ltm_CH_PR,c(38,3,36,5),item_36_PR,item_38_PR, "item 36.a", "item 38.a", "CCI Ciências Humanas do Paraná")

# item_36_PA <- data.frame(theta = -1.2, 
#                          probabilidade = 0.50,
#                          discriminacao = dif_modelo_3PL_ltm_CH_PA$discriminacao_item[36],
#                          acerto_acaso_item =dif_modelo_3PL_ltm_CH_PA$acerto_acaso_item[36]
#                          )

# item_38_PA <- data.frame(theta = 4.0,
#                          probabilidade = 0.50,
#                          discriminacao = dif_modelo_3PL_ltm_CH_PA$discriminacao_item[38],
#                          acerto_acaso_item =dif_modelo_3PL_ltm_CH_PA$acerto_acaso_item[38]
#                          )

# scatter_plot_CH_PA <- gera_Scatter_comp(prob_3PL_ltm_CH_PA,c(38,3,36,5),item_36_PA,item_38_PA, "item 36.b", "item 38.b", "CCI Ciências Humanas do Pará")
#scatter_plot_MT_PR <- gera_Scatter_comp(prob_3PL_ltm_MT_PR,c(19,31,24,23,15,11,9))
#scatter_plot_MT_PA <- gera_Scatter_comp(prob_3PL_ltm_MT_PA,c(19,31,24,23,15,11,9))
#scatter_plot_LC_PR <- gera_Scatter_comp(prob_3PL_ltm_LC_PR,c(39,10,21,6,15,18,10))
#scatter_plot_LC_PA <- gera_Scatter_comp(prob_3PL_ltm_LC_PA,c(39,10,21,6,15,18,10))
#scatter_plot_MT_PR <- gera_Scatter_comp(prob_3PL_ltm_MT_PR,ordenar_questoes(dif_modelo_3PL_ltm_MT_PR))
#scatter_plot_LC_PR <- gera_Scatter_comp(prob_3PL_ltm_LC_PR,ordenar_questoes(dif_modelo_3PL_ltm_LC_PR))
#scatter_plot_MT_PA <- gera_Scatter_comp(prob_3PL_ltm_MT_PA,ordenar_questoes(dif_modelo_3PL_ltm_MT_PA))
#scatter_plot_LC_PA <- gera_Scatter_comp(prob_3PL_ltm_LC_PA,ordenar_questoes(dif_modelo_3PL_ltm_LC_PA))
#scatter_plot_CN_PR <- gera_Scatter_comp(prob_3PL_ltm_CN_PR,ordenar_questoes(dif_modelo_3PL_ltm_CN_PR))
#scatter_plot_CN_PA <- gera_Scatter_comp(prob_3PL_ltm_CN_PA,ordenar_questoes(dif_modelo_3PL_ltm_CN_PA))
```

```{r}
# scatter_plot_CH_PR
# scatter_plot_CH_PA
```

```{r}
#scatter_plot_negativo <- gera_Scatter_comp(prob_3PL_ltm_CH_PR,c(38,37))

```

```{r}

#scatter_plot_CH_PA
#scatter_plot_CH_PR
#scatter_plot_negativo
```

```{r}
#orca(scatter_plot_MT_PR,"graficos/grafico_3PL_LTM_MT_PR.pdf")
#orca(scatter_plot_LC_PR,"graficos/grafico_3PL_LTM_LC_PR.pdf")
#orca(scatter_plot_CN_PR,"graficos/grafico_3PL_LTM_CN_PR.pdf")
# orca(scatter_plot_CH_PR,"graficos/grafico_3PL_LTM_CH_PR.pdf")
# orca(scatter_plot_CH_PA,"graficos/grafico_3PL_LTM_CH_PA.pdf")
#orca(scatter_plot_MT_PA,"graficos/grafico_3PL_LTM_MT_PA.pdf")
#orca(scatter_plot_LC_PA,"graficos/grafico_3PL_LTM_LC_PA.pdf")
#orca(scatter_plot_CN_PA,"graficos/grafico_3PL_LTM_CN_PA.pdf")

```
```{r}
# orca(scatter_plot_CH_PR,"graficos/grafico_3PL_LTM_CH_PR.pdf")
# orca(scatter_plot_CH_PA,"graficos/grafico_3PL_LTM_CH_PA.pdf")
#orca(scatter_plot_CCI_Negativa,"graficos/grafico_3PL_CCI_Negativa.pdf")
```


```{r}
# Filtrando valores usando uma inequação
# resultado <- subset(habil_3PL_ltm_CH_PR, habilidade > 30)

```

